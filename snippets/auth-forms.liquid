{% comment %}
  Authentication Forms - Sign In / Sign Up
  Handles user login, registration, social auth, and factory account access
  Integrates with Shopify Customer Accounts
{% endcomment %}

<div class="auth-container" id="auth-container">
  <style>
    .auth-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .auth-tabs {
      display: flex;
      border-radius: 1rem;
      background: #f1f5f9;
      padding: 0.5rem;
      margin-bottom: 3rem;
    }
    
    .auth-tab {
      flex: 1;
      padding: 1rem;
      border: none;
      background: transparent;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .auth-tab.active {
      background: white;
      color: #8B5CF6;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .auth-form {
      display: none;
      background: white;
      padding: 3rem;
      border-radius: 1.5rem;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
    }
    
    .auth-form.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 2rem;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1e293b;
    }
    
    .form-input {
      width: 100%;
      padding: 1.2rem;
      border: 2px solid #e2e8f0;
      border-radius: 0.8rem;
      font-size: 1.6rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #8B5CF6;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }
    
    .form-button {
      width: 100%;
      padding: 1.5rem;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      color: white;
      border: none;
      border-radius: 0.8rem;
      font-size: 1.6rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .form-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
    }
    
    .form-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 2rem 0;
      color: #64748b;
    }
    
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e2e8f0;
    }
    
    .auth-divider span {
      padding: 0 1rem;
    }
    
    .factory-access {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      padding: 2rem;
      border-radius: 1rem;
      margin-top: 2rem;
      text-align: center;
    }
    
    .factory-access h3 {
      margin-bottom: 1rem;
      font-size: 1.8rem;
    }
    
    .factory-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .factory-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .shopify-auth-info {
      margin: 2rem 0;
      text-align: center;
    }
    
    .shopify-auth-info p {
      color: #64748b;
      font-size: 1.4rem;
      margin: 0;
    }
    
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: none;
    }
    
    .success-message {
      background: #f0fdf4;
      color: #16a34a;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      display: none;
    }
    
    .forgot-password {
      text-align: center;
      margin-top: 1rem;
    }
    
    .forgot-password a {
      color: #8B5CF6;
      text-decoration: none;
    }
    
    .forgot-password a:hover {
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .auth-container {
        padding: 1rem;
      }
      
      .auth-form {
        padding: 2rem;
      }
    }
  </style>

  <!-- Auth Tabs -->
  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchTab('signin')">Sign In</button>
    <button class="auth-tab" onclick="switchTab('signup')">Sign Up</button>
  </div>

  <!-- Sign In Form -->
  <div class="auth-form active" id="signin-form">
    <div class="error-message" id="signin-error"></div>
    <div class="success-message" id="signin-success"></div>
    
         <!-- Shopify Native Customer Account Sign In -->
     <div class="shopify-auth-info">
       <p style="text-align: center; color: #64748b; margin-bottom: 1rem;">
         Sign in with your Shopify customer account
       </p>
     </div>
    
    <form onsubmit="handleSignIn(event)">
      <div class="form-group">
        <label class="form-label" for="signin-email">Email Address</label>
        <input type="email" id="signin-email" class="form-input" placeholder="your@email.com" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="signin-password">Password</label>
        <input type="password" id="signin-password" class="form-input" placeholder="Enter your password" required>
      </div>
      
      <button type="submit" class="form-button">Sign In</button>
    </form>
    
    <div class="forgot-password">
      <a href="#" onclick="showForgotPassword()">Forgot your password?</a>
    </div>
  </div>

  <!-- Sign Up Form -->
  <div class="auth-form" id="signup-form">
    <div class="error-message" id="signup-error"></div>
    <div class="success-message" id="signup-success"></div>
    
    <!-- Shopify Native Customer Account Sign Up -->
    <div class="shopify-auth-info">
      <p style="text-align: center; color: #64748b; margin-bottom: 1rem;">
        Create a new Shopify customer account
      </p>
    </div>
    
    <form onsubmit="handleSignUp(event)">
      <div class="form-group">
        <label class="form-label" for="signup-name">Full Name</label>
        <input type="text" id="signup-name" class="form-input" placeholder="John Doe" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="signup-email">Email Address</label>
        <input type="email" id="signup-email" class="form-input" placeholder="your@email.com" required>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="signup-password">Password</label>
        <input type="password" id="signup-password" class="form-input" placeholder="Create a strong password" required minlength="8">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="signup-confirm">Confirm Password</label>
        <input type="password" id="signup-confirm" class="form-input" placeholder="Confirm your password" required minlength="8">
      </div>
      
      <button type="submit" class="form-button">Create Account</button>
    </form>
  </div>

  <!-- Logout Option (if logged in) -->
  <div id="logout-section" style="display: none; background: #fef2f2; color: #dc2626; padding: 2rem; border-radius: 1rem; margin-top: 2rem; text-align: center;">
    <h3>üö™ Already Signed In?</h3>
    <p>You are currently logged in. Click below to sign out and access the sign-in form.</p>
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
      <button class="factory-button" style="background: #dc2626; border-color: #dc2626;" onclick="forceLogout()">Sign Out</button>
      <a href="/account" class="factory-button" style="background: #8B5CF6; border-color: #8B5CF6; text-decoration: none;">Manage Account</a>
    </div>
  </div>

  <!-- Factory Access (Admin Testing) -->
  <div class="factory-access">
    <h3>üè≠ Factory Access</h3>
    <p>Secure testing environment with full system access</p>
    <button class="factory-button" onclick="factoryLogin()">Access Factory Account</button>
  </div>
</div>

<script>
let currentTab = 'signin';

function switchTab(tab) {
  currentTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.auth-tab').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update forms
  document.querySelectorAll('.auth-form').forEach(form => {
    form.classList.remove('active');
  });
  document.getElementById(tab + '-form').classList.add('active');
  
  // Clear messages
  clearMessages();
}

function clearMessages() {
  document.querySelectorAll('.error-message, .success-message').forEach(msg => {
    msg.style.display = 'none';
    msg.textContent = '';
  });
}

function showError(formType, message) {
  const errorEl = document.getElementById(formType + '-error');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
}

function showSuccess(formType, message) {
  const successEl = document.getElementById(formType + '-success');
  successEl.textContent = message;
  successEl.style.display = 'block';
}

async function handleSignIn(event) {
  event.preventDefault();
  clearMessages();
  
  const email = document.getElementById('signin-email').value;
  const password = document.getElementById('signin-password').value;
  
  console.log('üîê Attempting sign in with:', { email, password: password ? '***' : 'empty' });
  
  try {
    showSuccess('signin', 'Redirecting to Shopify sign in...');
    
    // Simply redirect to Shopify's login page
    // Let Shopify handle all the CAPTCHA and form validation
    console.log('üîÑ Redirecting to:', '/account/login');
    window.location.href = '/account/login';
    
  } catch (error) {
    console.error('‚ùå Sign in error:', error);
    showError('signin', 'Error redirecting to sign in. Please try again.');
  }
}

async function handleSignUp(event) {
  event.preventDefault();
  clearMessages();
  
  const name = document.getElementById('signup-name').value;
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;
  const confirmPassword = document.getElementById('signup-confirm').value;
  
  console.log('üìù Attempting sign up with:', { 
    name, 
    email, 
    password: password ? '***' : 'empty',
    confirmPassword: confirmPassword ? '***' : 'empty'
  });
  
  // Validate passwords match
  if (password !== confirmPassword) {
    showError('signup', 'Passwords do not match.');
    return;
  }
  
  // Validate password strength
  if (password.length < 8) {
    showError('signup', 'Password must be at least 8 characters long.');
    return;
  }
  
  try {
    showSuccess('signup', 'Redirecting to Shopify account creation...');
    
    // Simply redirect to Shopify's account creation page
    // Let Shopify handle all the CAPTCHA and form validation
    console.log('üîÑ Redirecting to:', '/account');
    window.location.href = '/account';
    
  } catch (error) {
    console.error('‚ùå Sign up error:', error);
    showError('signup', 'Error redirecting to account creation. Please try again.');
  }
}

// Shopify Native Customer Account Functions
// These functions integrate with Shopify's built-in customer account system

function factoryLogin() {
  // Factory account login with predefined credentials
  const factoryCredentials = {
    username: 'Factory',
    password: 'Msi08536',
    email: 'factory@piccatso.internal'
  };
  
  // Set factory session
  localStorage.setItem('piccatso_user', JSON.stringify({
    id: 'factory_001',
    email: factoryCredentials.email,
    name: 'Factory Account',
    tier: 'factory',
    isFactory: true,
    isLoggedIn: true,
    loginTime: new Date().toISOString(),
    permissions: {
      fullAccess: true,
      adminPanel: true,
      testingMode: true,
      unlimitedGenerations: true,
      allFeatures: true
    }
  }));
  
  // Initialize Factory tier in subscription manager
  if (window.PiccatsoSubscription) {
    window.PiccatsoSubscription.initializeUser(factoryCredentials.email, 'factory');
    window.PiccatsoSubscription.setFactoryMode(true);
  }
  
  // Update header navigation
  window.dispatchEvent(new Event('piccatso-auth-change'));
  
  // Force immediate header refresh
  if (window.refreshAuthButton) {
    window.refreshAuthButton();
  }
  
  // Show success and redirect
  showSuccess('signin', 'Factory access granted! Redirecting to account...');
  
  setTimeout(() => {
    window.location.href = '/pages/account?factory=true';
  }, 1500);
}

function showForgotPassword() {
  alert('Password reset functionality would integrate with Shopify customer accounts. For now, contact support or use the Factory account for testing.');
}

function forceLogout() {
  // Clear all data immediately
  localStorage.clear();
  sessionStorage.clear();
  
  // Remove Factory banner if present
  const banner = document.getElementById('factory-mode-banner');
  if (banner) {
    banner.remove();
    document.body.style.paddingTop = '';
  }
  
  // Update header
  window.dispatchEvent(new Event('piccatso-auth-change'));
  if (window.refreshAuthButton) {
    window.refreshAuthButton();
  }
  
  // Hide logout section and show success
  document.getElementById('logout-section').style.display = 'none';
  showSuccess('signin', 'You have been logged out successfully. You can now sign in with a different account.');
  
  // If user was logged into Shopify, redirect to Shopify logout
  const user = JSON.parse(localStorage.getItem('piccatso_user') || '{}');
  if (user.loginMethod === 'shopify') {
    // Redirect to Shopify's logout page
    setTimeout(() => {
      window.location.href = '/account/logout';
    }, 1500);
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Check URL for logout parameter
  const urlParams = new URLSearchParams(window.location.search);
  const isLogout = urlParams.get('logout') === 'true';
  
  if (isLogout) {
    // User wants to log out - clear data and show logout message
    localStorage.removeItem('piccatso_user');
    localStorage.removeItem('piccatso_user_data');
    sessionStorage.clear();
    
    // Remove Factory banner if present
    const banner = document.getElementById('factory-mode-banner');
    if (banner) {
      banner.remove();
      document.body.style.paddingTop = '';
    }
    
    // Update header
    window.dispatchEvent(new Event('piccatso-auth-change'));
    if (window.refreshAuthButton) {
      window.refreshAuthButton();
    }
    
    showSuccess('signin', 'You have been logged out successfully.');
    
    // Clean URL
    window.history.replaceState({}, document.title, window.location.pathname);
    return;
  }
  
  // Check for Shopify customer account success (if redirected from account creation)
  const shopifySuccess = urlParams.get('shopify_success') === 'true';
  if (shopifySuccess) {
    showSuccess('signin', 'Account created successfully! You can now sign in with your email and password.');
    // Clean URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  // Check if user is already logged in via Shopify or local storage
  checkShopifyCustomerStatus();
});

// Function to check if user is logged into Shopify
async function checkShopifyCustomerStatus() {
  try {
    console.log('üîç Checking Shopify customer status...');
    
    // Check if we have a Shopify customer object (this means user is logged in)
    if (typeof window.Shopify !== 'undefined' && window.Shopify.customer) {
      const customer = window.Shopify.customer;
      console.log('üì± Shopify customer object found:', customer);
      
      if (customer.id) {
        console.log('‚úÖ Valid Shopify customer ID:', customer.id);
        
        // User is logged into Shopify - sync with local system
        const userData = {
          id: 'shopify_' + customer.id,
          email: customer.email,
          name: customer.first_name + ' ' + customer.last_name,
          tier: 'free', // Default tier
          isLoggedIn: true,
          loginTime: new Date().toISOString(),
          loginMethod: 'shopify',
          shopifyCustomerId: customer.id
        };
        
        console.log('üíæ Storing user data:', userData);
        
        // Store in localStorage
        localStorage.setItem('piccatso_user', JSON.stringify(userData));
        
        // Initialize subscription manager
        if (window.PiccatsoSubscription) {
          window.PiccatsoSubscription.initializeUser(customer.email, 'free');
        }
        
        // Update header navigation
        window.dispatchEvent(new Event('piccatso-auth-change'));
        if (window.refreshAuthButton) {
          window.refreshAuthButton();
        }
        
        // Show logout section
        document.getElementById('logout-section').style.display = 'block';
        const logoutSection = document.getElementById('logout-section');
        logoutSection.querySelector('p').textContent = `You are logged in as ${userData.name} (${userData.tier} tier). Click below to sign out.`;
        
        return;
      } else {
        console.log('‚ùå No valid customer ID found');
      }
    } else {
      console.log('‚ùå No Shopify customer object found');
      console.log('üîç window.Shopify:', window.Shopify);
    }
    
    // Check local storage for existing user
    const user = JSON.parse(localStorage.getItem('piccatso_user') || '{}');
    console.log('üíæ Local storage user data:', user);
    
    if (user.email && user.isLoggedIn) {
      console.log('‚úÖ Local user found:', user.email);
      
      // Show logout section
      document.getElementById('logout-section').style.display = 'block';
      
      // Update the logout section with user info
      const logoutSection = document.getElementById('logout-section');
      const userName = user.name || 'User';
      const tierName = user.tier ? user.tier.charAt(0).toUpperCase() + user.tier.slice(1) : 'Free';
      
      logoutSection.querySelector('p').textContent = `You are logged in as ${userName} (${tierName} tier). Click below to sign out.`;
    } else {
      console.log('‚ùå No local user found');
    }
    
  } catch (error) {
    console.error('‚ùå Error checking Shopify customer status:', error);
  }
}
</script>
