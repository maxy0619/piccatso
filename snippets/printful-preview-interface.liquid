{% comment %}
  Printful Integration Preview Interface
  Allows testing POD functionality without Piccatso API
{% endcomment %}

<div class="printful-preview-container">
  <style>
    .printful-preview-container {
      max-width: 120rem;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    .preview-section {
      background: white;
      border-radius: 1.6rem;
      padding: 3rem;
      margin-bottom: 3rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .preview-section h2 {
      font-size: 2.4rem;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sample-images {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }
    
    .sample-image {
      position: relative;
      border-radius: 1.2rem;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease;
      border: 3px solid transparent;
    }
    
    .sample-image:hover {
      transform: translateY(-4px);
    }
    
    .sample-image.selected {
      border-color: #8B5CF6;
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.3);
    }
    
    .sample-image img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    
    .sample-image .overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 1rem;
      font-weight: 600;
    }
    
    .api-status {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      border-radius: 0.8rem;
      margin-bottom: 2rem;
      font-weight: 500;
    }
    
    .api-status.connected {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .api-status.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }
    
    .api-status.loading {
      background: #fefbf0;
      color: #d97706;
      border: 1px solid #fed7aa;
    }
    
    .status-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    
    .status-icon.green { background: #10b981; }
    .status-icon.red { background: #ef4444; }
    .status-icon.yellow { background: #f59e0b; }
    
    .test-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 2rem;
    }
    
    .test-btn {
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      color: white;
      border: none;
      border-radius: 0.8rem;
      padding: 1rem 2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }
    
    .test-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .test-results {
      background: #f8fafc;
      border-radius: 0.8rem;
      padding: 2rem;
      margin-top: 2rem;
      font-family: monospace;
      font-size: 1.4rem;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>

  <!-- API Connection Status -->
  <div class="preview-section">
    <h2>üîå API Connection Status</h2>
    <div id="api-status" class="api-status loading">
      <div class="status-icon yellow"></div>
      <span>Testing Printful API connection...</span>
    </div>
    
    <div class="test-buttons">
      <button class="test-btn" onclick="testPrintfulOffline()" style="background: linear-gradient(135deg, #10b981, #059669);">üß™ Test Integration (Offline)</button>
      <button class="test-btn" onclick="testAPIConnection()" style="opacity: 0.6;" title="Will show CORS error (expected)">üåê Test API (Shows CORS)</button>
      <button class="test-btn" onclick="validatePricingDemo()" style="background: linear-gradient(135deg, #f59e0b, #d97706);">üí∞ Validate Pricing</button>
    </div>
    
    <div id="test-results" class="test-results" style="display: none;">
      <strong>Test Results:</strong><br>
      <div id="results-content"></div>
    </div>
  </div>

  <!-- Sample Images for Testing -->
  <div class="preview-section">
    <h2>üé® Sample Images</h2>
    <p>Select a sample image to test the print-on-demand interface:</p>
    
    <div class="sample-images">
      <div class="sample-image" onclick="selectSampleImage(this, 'https://picsum.photos/800/600?random=1')">
        <img src="https://picsum.photos/300/200?random=1" alt="Sample Art 1">
        <div class="overlay">Abstract Art Style</div>
      </div>
      
      <div class="sample-image" onclick="selectSampleImage(this, 'https://picsum.photos/800/600?random=2')">
        <img src="https://picsum.photos/300/200?random=2" alt="Sample Art 2">
        <div class="overlay">Landscape Style</div>
      </div>
      
      <div class="sample-image" onclick="selectSampleImage(this, 'https://picsum.photos/800/600?random=3')">
        <img src="https://picsum.photos/300/200?random=3" alt="Sample Art 3">
        <div class="overlay">Portrait Style</div>
      </div>
      
      <div class="sample-image" onclick="selectSampleImage(this, 'https://picsum.photos/800/600?random=4')">
        <img src="https://picsum.photos/300/200?random=4" alt="Sample Art 4">
        <div class="overlay">Modern Art Style</div>
      </div>
    </div>
  </div>

  <!-- Print-on-Demand Interface -->
  <div class="preview-section">
    <h2>üñ®Ô∏è Print-on-Demand Interface</h2>
    <p>This is your actual POD interface. Select a sample image above to activate it:</p>
    
    <!-- Include the actual POD interface -->
    {% render 'pod-interface' %}
    
    <!-- Load test scripts -->
    <script src="{{ 'printful-offline-tester.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'printful-status-checker.js' | asset_url }}" defer="defer"></script>
    <script src="{{ 'printful-test.js' | asset_url }}" defer="defer"></script>
  </div>

  <!-- Pricing Preview -->
  <div class="preview-section">
    <h2>üí∞ Pricing Preview (100% Markup)</h2>
    <div id="pricing-preview">
      <p>Select a product type and size above to see pricing calculations...</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Test integration offline on page load (avoids CORS issues)
  setTimeout(function() {
    if (typeof testPrintfulOffline === 'function') {
      testPrintfulOffline();
    } else {
      // Fallback to API test if offline tester not loaded
      testAPIConnection();
    }
  }, 1000);
  
  // Initialize pricing preview
  updatePricingPreview();
});

// Test Printful API connection
async function testAPIConnection() {
  const statusDiv = document.getElementById('api-status');
  const resultsDiv = document.getElementById('test-results');
  const resultsContent = document.getElementById('results-content');
  
  // Update status to loading
  statusDiv.className = 'api-status loading';
  statusDiv.innerHTML = '<div class="status-icon yellow"></div><span>Testing connection...</span>';
  
  try {
    if (!window.PrintfulCredentials || !window.PrintfulCredentials.isConfigured()) {
      throw new Error('Printful credentials not configured');
    }
    
    const response = await fetch('https://api.printful.com/store/products', {
      headers: window.PrintfulCredentials.getHeaders()
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Success
      statusDiv.className = 'api-status connected';
      statusDiv.innerHTML = '<div class="status-icon green"></div><span>‚úÖ Connected! Found ' + (data.result?.length || 0) + ' products</span>';
      
      // Show results
      resultsDiv.style.display = 'block';
      resultsContent.innerHTML = 'API Response: ' + JSON.stringify(data, null, 2);
      
    } else {
      throw new Error('HTTP ' + response.status + ': ' + response.statusText);
    }
    
  } catch (error) {
    // Error
    statusDiv.className = 'api-status error';
    statusDiv.innerHTML = '<div class="status-icon red"></div><span>‚ùå Connection failed: ' + error.message + '</span>';
    
    resultsDiv.style.display = 'block';
    resultsContent.innerHTML = 'Error: ' + error.message;
  }
}

// Fetch and display product catalog
async function fetchProductCatalog() {
  const resultsDiv = document.getElementById('test-results');
  const resultsContent = document.getElementById('results-content');
  
  resultsDiv.style.display = 'block';
  resultsContent.innerHTML = 'Fetching product catalog...';
  
  try {
    const response = await fetch('https://api.printful.com/products', {
      headers: window.PrintfulCredentials.getHeaders()
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Filter relevant products
      const artProducts = data.result.filter(product => {
        const name = product.name.toLowerCase();
        const type = product.type.toLowerCase();
        return name.includes('canvas') || name.includes('poster') || 
               name.includes('metal') || name.includes('frame') ||
               type.includes('print');
      });
      
      resultsContent.innerHTML = `
        <strong>Found ${artProducts.length} relevant art print products:</strong><br><br>
        ${artProducts.map(product => 
          `‚Ä¢ ${product.name} (ID: ${product.id}) - ${product.type}`
        ).join('<br>')}
      `;
      
    } else {
      throw new Error('HTTP ' + response.status);
    }
    
  } catch (error) {
    resultsContent.innerHTML = 'Error fetching catalog: ' + error.message;
  }
}

// Test mockup generation
async function testMockupGeneration() {
  const resultsDiv = document.getElementById('test-results');
  const resultsContent = document.getElementById('results-content');
  
  resultsDiv.style.display = 'block';
  resultsContent.innerHTML = 'Testing mockup generation...';
  
  try {
    // Use a sample image URL
    const sampleImageUrl = 'https://picsum.photos/800/600?random=1';
    
    const mockupData = {
      product_id: 71, // Canvas print product ID
      variant_ids: [4011], // Sample variant ID
      files: [{
        placement: 'default',
        image_url: sampleImageUrl,
        position: { area_width: 1800, area_height: 2400 }
      }]
    };
    
    const response = await fetch('https://api.printful.com/mockup-generator/create-task/71', {
      method: 'POST',
      headers: window.PrintfulCredentials.getHeaders(),
      body: JSON.stringify(mockupData)
    });
    
    if (response.ok) {
      const data = await response.json();
      resultsContent.innerHTML = `
        <strong>Mockup generation initiated:</strong><br>
        Task Key: ${data.result.task_key}<br>
        Status: ${data.result.status}<br>
        <br>
        <em>Note: Mockup generation takes 20-60 seconds. Check Printful dashboard for results.</em>
      `;
    } else {
      throw new Error('HTTP ' + response.status);
    }
    
  } catch (error) {
    resultsContent.innerHTML = 'Error testing mockups: ' + error.message;
  }
}

// Select sample image and activate POD interface
function selectSampleImage(element, imageUrl) {
  // Remove previous selection
  document.querySelectorAll('.sample-image').forEach(img => {
    img.classList.remove('selected');
  });
  
  // Select current image
  element.classList.add('selected');
  
  // Activate POD interface with sample image
  if (window.showPODInterface) {
    window.showPODInterface(imageUrl);
  }
  
  // Update pricing preview
  updatePricingPreview();
}

// Update pricing preview
function updatePricingPreview() {
  const pricingDiv = document.getElementById('pricing-preview');
  
  const samplePricing = `
    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
      <thead>
        <tr style="background: #f8fafc;">
          <th style="padding: 1rem; text-align: left; border: 1px solid #e2e8f0;">Product</th>
          <th style="padding: 1rem; text-align: left; border: 1px solid #e2e8f0;">Size</th>
          <th style="padding: 1rem; text-align: left; border: 1px solid #e2e8f0;">Base Cost</th>
          <th style="padding: 1rem; text-align: left; border: 1px solid #e2e8f0;">Your Price</th>
          <th style="padding: 1rem; text-align: left; border: 1px solid #e2e8f0;">Profit</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">Canvas</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">A4 (8.3" √ó 11.7")</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">$21.50</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #8B5CF6;">$43.00</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #10b981;">$21.50</td>
        </tr>
        <tr style="background: #f8fafc;">
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">Canvas</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">18" √ó 24"</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">$49.50</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #8B5CF6;">$99.00</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #10b981;">$49.50</td>
        </tr>
        <tr>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">Poster</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">A4 (8.3" √ó 11.7")</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">$14.50</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #8B5CF6;">$29.00</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #10b981;">$14.50</td>
        </tr>
        <tr style="background: #f8fafc;">
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">Metal</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">18" √ó 24"</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0;">$85.50</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #8B5CF6;">$171.00</td>
          <td style="padding: 1rem; border: 1px solid #e2e8f0; font-weight: bold; color: #10b981;">$85.50</td>
        </tr>
      </tbody>
    </table>
    <p style="margin-top: 1rem; font-style: italic; color: #64748b;">
      * All prices calculated with 100% markup. Actual Printful costs may vary.
    </p>
  `;
  
  pricingDiv.innerHTML = samplePricing;
}
</script>
