{% comment %}
  Piccatso Account Dashboard
  Displays user's subscription, artwork, cart, and account management
  Integrates with subscription tiers and Printful orders
{% endcomment %}

<div class="account-dashboard" id="account-dashboard">
  <style>
    .account-dashboard {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .dashboard-nav {
      display: flex;
      gap: 1rem;
      margin-bottom: 3rem;
      border-bottom: 2px solid #e2e8f0;
      overflow-x: auto;
    }
    
    .nav-tab {
      padding: 1rem 2rem;
      background: none;
      border: none;
      font-size: 1.4rem;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    
    .nav-tab.active {
      color: #8B5CF6;
      border-bottom-color: #8B5CF6;
    }
    
    .nav-tab:hover {
      color: #8B5CF6;
    }
    
    .dashboard-content {
      display: none;
    }
    
    .dashboard-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    /* Subscription Tier Styling */
    .tier-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 1.2rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tier-free {
      background: #f1f5f9;
      color: #64748b;
    }
    
    .tier-premium {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
    }
    
    .tier-pro {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }
    
    /* Usage Progress Bar */
    .usage-container {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    
    .usage-progress-bar {
      width: 100%;
      height: 1rem;
      background: #e2e8f0;
      border-radius: 0.5rem;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .usage-progress {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #059669);
      transition: width 0.3s ease;
    }
    
    .usage-progress.warning {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }
    
    .usage-progress.danger {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }
    
    /* Upgrade Modal */
    .upgrade-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 3rem;
      border-radius: 1rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .upgrade-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }
    
    .upgrade-option {
      padding: 2rem;
      border: 2px solid #e2e8f0;
      border-radius: 1rem;
      text-align: center;
    }
    
    .upgrade-option.premium {
      border-color: #fbbf24;
    }
    
    .upgrade-option.pro {
      border-color: #8b5cf6;
    }
    
    .upgrade-option h4 {
      margin-bottom: 1rem;
      color: #1e293b;
    }
    
    .upgrade-option ul {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
    }
    
    .upgrade-option li {
      padding: 0.5rem 0;
      color: #64748b;
    }
    
    .upgrade-option button {
      width: 100%;
      padding: 1rem;
      background: #8b5cf6;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upgrade-option button:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }
    
    /* Order Management Styles */
    .order-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .order-info h4 {
      margin: 0;
      color: #1e293b;
      font-size: 1.6rem;
    }
    
    .order-date {
      margin: 0.5rem 0 0 0;
      color: #64748b;
      font-size: 1.4rem;
    }
    
    .order-status {
      font-weight: 600;
      font-size: 1.4rem;
    }
    
    .order-items {
      margin-bottom: 1.5rem;
    }
    
    .order-item {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1rem 0;
      border-bottom: 1px solid #f1f5f9;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-image {
      width: 60px;
      height: 60px;
      border-radius: 0.5rem;
      overflow: hidden;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .no-image {
      font-size: 2rem;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-details h5 {
      margin: 0 0 0.5rem 0;
      color: #1e293b;
      font-size: 1.4rem;
    }
    
    .item-details p {
      margin: 0.25rem 0;
      color: #64748b;
      font-size: 1.2rem;
    }
    
    .item-discount {
      color: #10b981 !important;
      font-weight: 600;
    }
    
    .item-price {
      font-weight: 600;
      color: #1e293b;
      font-size: 1.4rem;
    }
    
    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }
    
    .order-total {
      font-size: 1.6rem;
      color: #1e293b;
    }
    
    .order-actions {
      display: flex;
      gap: 1rem;
    }
    
    .track-button, .reorder-button {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
    }
    
    .track-button {
      background: #3b82f6;
      color: white;
    }
    
    .track-button:hover {
      background: #2563eb;
    }
    
    .reorder-button {
      background: #8b5cf6;
      color: white;
    }
    
    .reorder-button:hover {
      background: #7c3aed;
    }
    
    .tracking-info {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: #f8fafc;
      border-radius: 0.5rem;
    }
    
    .tracking-info h5 {
      margin: 0 0 1rem 0;
      color: #1e293b;
    }
    
    .tracking-info p {
      margin: 0.5rem 0;
      color: #64748b;
    }
    
    .track-link {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.8rem 1.5rem;
      background: #10b981;
      color: white;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 600;
    }
    
    .track-link:hover {
      background: #059669;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }
    
    .dashboard-card {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #f1f5f9;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }
    
    .card-icon.primary { background: linear-gradient(135deg, #8B5CF6, #A855F7); }
    .card-icon.success { background: linear-gradient(135deg, #10b981, #059669); }
    .card-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .card-icon.info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    
    .card-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #1e293b;
    }
    
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .stat-item {
      text-align: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 0.8rem;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: #8B5CF6;
    }
    
    .stat-label {
      font-size: 1.2rem;
      color: #64748b;
      margin-top: 0.5rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8B5CF6, #A855F7);
      transition: width 0.5s ease;
    }
    
    .subscription-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .badge-free { background: #f1f5f9; color: #64748b; }
    .badge-premium { background: #fef3c7; color: #92400e; }
    .badge-pro { background: #d1fae5; color: #065f46; }
    
    .action-button {
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 1rem;
    }
    
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
    }
    
    .action-button.secondary {
      background: #f1f5f9;
      color: #64748b;
    }
    
    .action-button.secondary:hover {
      background: #e2e8f0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .artwork-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .artwork-item {
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease;
      background: #f8fafc;
      aspect-ratio: 1;
    }
    
    .artwork-item:hover {
      transform: scale(1.05);
    }
    
    .artwork-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .artwork-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
      color: white;
      padding: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    
    .cart-item-image {
      width: 80px;
      height: 80px;
      border-radius: 0.5rem;
      object-fit: cover;
    }
    
    .cart-item-details {
      flex: 1;
    }
    
    .cart-item-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .cart-item-price {
      color: #10b981;
      font-weight: 700;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* User Profile Header */
    .user-profile-header {
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      color: white;
      padding: 3rem;
      border-radius: 2rem;
      margin-bottom: 3rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    }
    
    .profile-avatar {
      flex-shrink: 0;
    }
    
    .avatar-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 3px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.4rem;
      font-weight: 700;
      color: white;
    }
    
    .profile-info {
      flex-grow: 1;
    }
    
    .profile-name {
      font-size: 2.4rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      color: white;
    }
    
    .profile-email {
      font-size: 1.4rem;
      margin: 0 0 1rem 0;
      opacity: 0.9;
      color: white;
    }
    
    .profile-tier {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .tier-badge {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .login-status {
      font-size: 1.2rem;
      opacity: 0.8;
      color: #10b981;
      font-weight: 600;
    }
    
    .profile-actions {
      flex-shrink: 0;
    }
    
    .profile-actions .action-button {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
    }
    
    .profile-actions .action-button:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    @media (max-width: 768px) {
      .account-dashboard {
        padding: 1rem;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-nav {
        flex-wrap: wrap;
        overflow-x: auto;
        padding-bottom: 1rem;
      }
      
      .user-profile-header {
        flex-direction: column;
        text-align: center;
        padding: 2rem;
      }
      
      .profile-tier {
        justify-content: center;
      }
      
      /* Mobile-specific subscription styles */
      .usage-container {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      
      .upgrade-options {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .modal-content {
        padding: 2rem;
        margin: 1rem;
        max-height: 90vh;
      }
      
      /* Pro benefits mobile layout */
      #pro-benefits div {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
      
      /* Artwork grid mobile */
      .artwork-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      
      .artwork-card {
        padding: 1rem;
      }
      
      .artwork-overlay {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .download-btn, .delete-btn {
        padding: 0.5rem;
        font-size: 1.2rem;
      }
    }
    
    @media (max-width: 480px) {
      .account-dashboard {
        padding: 0.5rem;
      }
      
      .dashboard-nav {
        padding: 0.5rem;
      }
      
      .nav-tab {
        padding: 0.6rem 0.8rem;
        font-size: 1.1rem;
      }
      
      .usage-container {
        padding: 1rem;
      }
      
      .artwork-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        padding: 1.5rem;
        margin: 0.5rem;
      }
      
      .upgrade-option {
        padding: 1.5rem;
      }
    }
  </style>

  <!-- Dashboard Navigation -->
  <div class="dashboard-nav">
    <button class="nav-tab active" onclick="showDashboardTab('overview')">üìä Overview</button>
    <button class="nav-tab" onclick="showDashboardTab('artwork')">üé® My Artwork</button>
    <button class="nav-tab" onclick="showDashboardTab('cart')">üõí Shopping Cart</button>
    <button class="nav-tab" onclick="showDashboardTab('orders')">üì¶ Orders</button>
    <button class="nav-tab" onclick="showDashboardTab('settings')">üë§ Settings</button>
  </div>

  <!-- Overview Tab -->
  <div class="dashboard-content active" id="overview-content">
    <!-- User Profile Header -->
    <div class="user-profile-header" id="user-profile-header">
      <div class="profile-avatar">
        <div class="avatar-circle" id="avatar-circle">
          <span id="avatar-initials">U</span>
        </div>
      </div>
      <div class="profile-info">
        <h2 class="profile-name" id="profile-name">Welcome back!</h2>
        <p class="profile-email" id="profile-email">Loading...</p>
        <div class="profile-tier" id="profile-tier-display">
          <span class="tier-badge" id="tier-badge">Free Tier</span>
          <span class="login-status" id="login-status">‚óè Online</span>
        </div>
      </div>
      <div class="profile-actions">
        <button class="action-button secondary" onclick="showDashboardTab('settings')">
          ‚öôÔ∏è Edit Profile
        </button>
      </div>
    </div>
    
    <!-- Subscription Status -->
    <div class="usage-container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Your Subscription</h3>
        <span class="tier-badge current-tier tier-free">Free</span>
      </div>
      
      <div class="usage-stats">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
          <span>Monthly Generations</span>
          <span class="usage-text">0 / 10 used</span>
        </div>
        <div class="usage-progress-bar">
          <div class="usage-progress" style="width: 0%"></div>
        </div>
        <p style="color: #64748b; font-size: 1.4rem; margin-top: 1rem;">
          <span id="remaining-generations">10</span> generations remaining this month
        </p>
      </div>
      
      <div style="margin-top: 2rem; display: flex; gap: 1rem;">
        <button onclick="showSubscriptionModal()" class="action-button" style="flex: 1; background: #10b981; color: white; padding: 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
          Manage Subscription
        </button>
        <button onclick="manageBilling()" class="action-button secondary" style="flex: 1; background: #64748b; color: white; padding: 1rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
          Billing
        </button>
      </div>
      
      <!-- Pro Tier Benefits Display -->
      <div id="pro-benefits" style="display: none; margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border-radius: 1rem;">
        <h4 style="margin-bottom: 1rem;">üéâ Pro Tier Benefits</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 1.4rem;">
          <div>‚úÖ Clean downloads (no watermark)</div>
          <div>‚úÖ Commercial usage rights</div>
          <div>‚úÖ Unlimited art history</div>
          <div>‚úÖ <span id="pro-discount">10%</span> discount on all prints</div>
        </div>
      </div>
      
      <!-- Debug Section (for testing) -->
      <div style="margin-top: 2rem; padding: 1.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem;">
        <h4 style="margin-bottom: 1rem; color: #1e293b;">üîß Debug Tools</h4>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button onclick="testCustomerData()" class="action-button secondary" style="font-size: 1.2rem; padding: 0.8rem 1.5rem;">Test Customer Data</button>
          <button onclick="forceLoadCustomerData()" class="action-button" style="font-size: 1.2rem; padding: 0.8rem 1.5rem; background: #10b981;">Force Load Customer</button>
          <button onclick="inspectCustomerObject()" class="action-button secondary" style="font-size: 1.2rem; padding: 0.8rem 1.5rem;">Inspect Customer</button>
          <button onclick="manualCustomerFix()" class="action-button" style="font-size: 1.2rem; padding: 0.8rem 1.5rem; background: #f59e0b;">Manual Fix</button>
          <button onclick="setTestTier('premium')" class="action-button secondary" style="font-size: 1.2rem; padding: 0.8rem 1.5rem;">Set Premium Tier</button>
          <button onclick="setTestTier('pro')" class="action-button secondary" style="font-size: 1.2rem; padding: 0.8rem 1.5rem;">Set Pro Tier</button>
          <button onclick="refreshDashboard()" class="action-button secondary" style="font-size: 1.2rem; padding: 0.8rem 1.5rem;">Refresh Dashboard</button>
        </div>
        <div id="debug-output" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 0.5rem; font-family: monospace; font-size: 1.2rem; color: #64748b;"></div>
      </div>
    </div>
    
    <div class="dashboard-grid">
      
      <!-- Subscription Status Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon primary">‚≠ê</div>
          <div class="card-title">Subscription Status</div>
        </div>
        <div class="subscription-badge badge-free" id="subscription-badge">
          üÜì Free Tier
        </div>
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-value" id="generations-used">0</div>
            <div class="stat-label">Used This Month</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="generations-limit">10</div>
            <div class="stat-label">Monthly Limit</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="usage-progress" style="width: 0%"></div>
        </div>
        <!-- Subscription management moved to main subscription section -->
      </div>
      
      <!-- Quick Stats Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon success">üìà</div>
          <div class="card-title">Quick Stats</div>
        </div>
        <div class="stat-grid">
          <div class="stat-item">
            <div class="stat-value" id="total-artworks">0</div>
            <div class="stat-label">Total Artworks</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="total-prints">0</div>
            <div class="stat-label">Prints Ordered</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="cart-items">0</div>
            <div class="stat-label">Cart Items</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="favorites-count">0</div>
            <div class="stat-label">Favorites</div>
          </div>
        </div>
      </div>
      
      <!-- Recent Activity Card -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon info">üïí</div>
          <div class="card-title">Recent Activity</div>
        </div>
        <div id="recent-activity">
          <div class="empty-state">
            <div class="empty-state-icon">üé®</div>
            <p>No recent activity yet.<br>Start creating some AI art!</p>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- My Artwork Tab -->
  <div class="dashboard-content" id="artwork-content">
    <div class="dashboard-card">
      <div class="card-header">
        <div class="card-icon primary">üé®</div>
        <div class="card-title">My Artwork Collection</div>
        <div class="storage-stats"></div>
      </div>
      
      <!-- Artwork Filters -->
      <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="action-button secondary" onclick="filterArtwork('all')">All</button>
        <button class="action-button secondary" onclick="filterArtwork('recent')">Recent</button>
        <button class="action-button secondary" onclick="filterArtwork('favorites')">Favorites</button>
        <button class="action-button secondary" onclick="filterArtwork('prints')">Ready to Print</button>
      </div>
      
      <!-- Artwork Grid -->
      <div class="artwork-grid" id="artwork-grid">
        <div class="empty-state">
          <div class="empty-state-icon">üé®</div>
          <p>No artwork saved yet.<br>Create your first AI masterpiece!</p>
          <button class="action-button" onclick="window.location.href='/pages/create'">
            Create AI Art
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shopping Cart Tab -->
  <div class="dashboard-content" id="cart-content">
    <div class="dashboard-grid">
      
      <!-- Current Cart -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon warning">üõí</div>
          <div class="card-title">Current Cart</div>
        </div>
        <div id="current-cart-items">
          <div class="empty-state">
            <div class="empty-state-icon">üõí</div>
            <p>Your cart is empty.<br>Add some prints to get started!</p>
          </div>
        </div>
        <button class="action-button" onclick="window.location.href='/cart'">
          View Full Cart
        </button>
      </div>
      
      <!-- Saved for Later -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon info">üíæ</div>
          <div class="card-title">Saved for Later</div>
        </div>
        <div id="saved-items">
          <div class="empty-state">
            <div class="empty-state-icon">üíæ</div>
            <p>No items saved for later.</p>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Orders Tab -->
  <div class="dashboard-content" id="orders-content">
    <div class="dashboard-card">
      <div class="card-header">
        <div class="card-icon success">üì¶</div>
        <div class="card-title">Order History</div>
      </div>
      
      <!-- Order Filters -->
      <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <button class="action-button secondary" onclick="filterOrders('all')">All Orders</button>
        <button class="action-button secondary" onclick="filterOrders('pending')">Pending</button>
        <button class="action-button secondary" onclick="filterOrders('shipped')">Shipped</button>
        <button class="action-button secondary" onclick="filterOrders('delivered')">Delivered</button>
      </div>
      
      <div id="order-history">
        <div class="empty-state">
          <div class="empty-state-icon">üì¶</div>
          <p>No orders yet.<br>Your print orders will appear here!</p>
          <a href="/" class="action-button">Start Creating Art</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Tab -->
  <div class="dashboard-content" id="settings-content">
    <div class="dashboard-grid">
      
      <!-- Account Settings -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon primary">üë§</div>
          <div class="card-title">Account Settings</div>
        </div>
        <div style="space-y: 1rem;">
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email Address</label>
            <input type="email" id="user-email" style="width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;" readonly>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Display Name</label>
            <input type="text" id="user-name" style="width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
          </div>
        </div>
        <button class="action-button" onclick="updateAccountSettings()">
          Update Settings
        </button>
      </div>
      
      <!-- Password Management -->
      <div class="dashboard-card">
        <div class="card-header">
          <div class="card-icon info">üîí</div>
          <div class="card-title">Password & Security</div>
        </div>
        <div id="password-form" style="display: none;">
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Current Password</label>
            <input type="password" id="current-password" style="width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;" placeholder="Enter current password">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">New Password</label>
            <input type="password" id="new-password" style="width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;" placeholder="Enter new password" minlength="8">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Confirm New Password</label>
            <input type="password" id="confirm-password" style="width: 100%; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem;" placeholder="Confirm new password" minlength="8">
          </div>
          <div style="display: flex; gap: 1rem;">
            <button class="action-button" onclick="updatePassword()">
              Update Password
            </button>
            <button class="action-button secondary" onclick="cancelPasswordChange()">
              Cancel
            </button>
          </div>
        </div>
        <div id="password-prompt">
          <p style="margin-bottom: 1rem; color: #64748b;">Keep your account secure with a strong password.</p>
          <button class="action-button" onclick="showPasswordForm()">
            Change Password
          </button>
        </div>
      </div>
      
      <!-- Subscription management consolidated into main subscription section above -->
      
    </div>
  </div>

</div>

<!-- Subscription Management Modal -->
<div id="subscription-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 1.5rem; padding: 3rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 style="margin: 0;">Manage Subscription</h2>
      <button onclick="closeSubscriptionModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
    </div>
    
    <!-- Current Subscription Status -->
    <div id="current-subscription-status" style="background: #f8fafc; border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
      <h3 style="margin: 0 0 1rem 0; color: #1e293b;">Current Plan</h3>
      <div id="current-plan-display">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
    
    <!-- Subscription Options -->
    <div id="subscription-options">
      <h3 style="margin-bottom: 1.5rem; color: #1e293b;">Available Plans</h3>
      
      <!-- Free Tier -->
      <div class="subscription-plan" data-plan="free" data-action="downgrade" style="border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" onclick="selectSubscriptionPlan('free', 'downgrade')">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #64748b;">üÜì Free Tier</h4>
          <span style="font-size: 1.2rem; font-weight: bold; color: #64748b;">$0/month</span>
        </div>
        <ul style="margin: 0; padding-left: 1.5rem; color: #64748b; font-size: 0.9rem;">
          <li>10 generations per month</li>
          <li>Standard resolution (512x512px)</li>
          <li>Watermarked downloads</li>
          <li>Community support</li>
        </ul>
      </div>
      
      <!-- Premium Tier -->
      <div class="subscription-plan" data-plan="premium" data-action="upgrade" style="border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" onclick="selectSubscriptionPlan('premium', 'upgrade')">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #8B5CF6;">‚≠ê Premium Tier</h4>
          <span style="font-size: 1.2rem; font-weight: bold; color: #8B5CF6;">$9.99/month</span>
        </div>
        <ul style="margin: 0; padding-left: 1.5rem; color: #64748b; font-size: 0.9rem;">
          <li>100 generations per month</li>
          <li>High resolution (1024x1024px)</li>
          <li>Art history saved (50 creations)</li>
          <li>Favorites collection</li>
          <li>Email support (48hr response)</li>
        </ul>
      </div>
      
      <!-- Pro Tier -->
      <div class="subscription-plan" data-plan="pro" data-action="upgrade" style="border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" onclick="selectSubscriptionPlan('pro', 'upgrade')">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h4 style="margin: 0; color: #10b981;">üé® Pro Tier</h4>
          <span style="font-size: 1.2rem; font-weight: bold; color: #10b981;">$39.99/month</span>
        </div>
        <ul style="margin: 0; padding-left: 1.5rem; color: #64748b; font-size: 0.9rem;">
          <li>200 generations per month</li>
          <li>Ultra high resolution (2048x2048px)</li>
          <li>Unlimited art history</li>
          <li>Commercial usage rights</li>
          <li>Priority support</li>
          <li>10% discount on prints</li>
        </ul>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div id="subscription-actions" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
      <div id="action-description" style="margin-bottom: 1.5rem; padding: 1rem; background: #f1f5f9; border-radius: 0.5rem; font-size: 0.9rem; color: #475569;">
        <!-- Will be populated by JavaScript -->
      </div>
      <div style="display: flex; gap: 1rem;">
        <button id="confirm-subscription-action" class="action-button" style="flex: 1; padding: 1rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
          <!-- Text will be set by JavaScript -->
        </button>
        <button onclick="closeSubscriptionModal()" class="action-button secondary" style="flex: 1; padding: 1rem; background: #64748b; color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
// Dashboard functionality
let currentUser = {
  tier: 'free',
  generationsUsed: 0,
  generationsLimit: 10,
  artworks: [],
  cartItems: [],
  orders: [],
  email: '',
  name: ''
};

let selectedPlan = null;

// Initialize dashboard
function initializeDashboard() {
  loadUserData();
  updateUserProfile();
  updateDashboardStats();
  loadRecentActivity();
}

// Tab switching
function showDashboardTab(tabName) {
  // Update nav tabs
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update content
  document.querySelectorAll('.dashboard-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(tabName + '-content').classList.add('active');
  
  // Load tab-specific data
  switch(tabName) {
    case 'artwork':
      loadArtworkCollection();
      break;
    case 'cart':
      loadCartItems();
      break;
    case 'orders':
      loadOrderHistory();
      break;
    case 'settings':
      loadAccountSettings();
      break;
  }
}

// Load user data from localStorage and Shopify customer
function loadUserData() {
  console.log('üîç Loading user data...');
  console.log('üîç window.Shopify:', window.Shopify);
  console.log('üîç window.customer:', window.customer);
  console.log('üîç typeof customer:', typeof customer);
  console.log('üîç customer object:', customer);
  
  // First, try to get data from subscription manager if available
  if (window.subscriptionManager && window.subscriptionManager.customer) {
    const customer = window.subscriptionManager.customer;
    currentUser.email = customer.email || '';
    currentUser.name = `${customer.first_name} ${customer.last_name}`.trim() || '';
    currentUser.tier = window.subscriptionManager.currentTier || 'free';
    currentUser.isLoggedIn = true;
    currentUser.id = customer.id || '';
    currentUser.provider = 'shopify';
    currentUser.isFactory = currentUser.tier === 'factory';
    
    console.log('‚úÖ Loaded user data from subscription manager:', currentUser);
    return;
  }
  
  // Load from localStorage (fallback)
  const userData = localStorage.getItem('piccatso_user');
  const userDataExtended = localStorage.getItem('piccatso_user_data');
  
  if (userData) {
    const user = JSON.parse(userData);
    currentUser.email = user.email || '';
    currentUser.name = user.name || '';
    currentUser.tier = user.tier || 'free';
    currentUser.isLoggedIn = user.isLoggedIn || false;
    currentUser.id = user.id || '';
    currentUser.provider = user.provider || '';
    currentUser.isFactory = user.isFactory || false;
    
    console.log('üì¶ Loaded from localStorage:', user);
  }
  
  if (userDataExtended) {
    const extendedData = JSON.parse(userDataExtended);
    currentUser = { ...currentUser, ...extendedData };
  }
  
  // Fallback to Shopify customer data if available
  if (typeof customer !== 'undefined' && customer && !currentUser.email) {
    currentUser.email = customer.email || '';
    currentUser.name = (customer.first_name + ' ' + customer.last_name).trim() || '';
    
    // Load subscription tier from customer tags
    if (customer.tags) {
      if (customer.tags.includes('premium')) currentUser.tier = 'premium';
      if (customer.tags.includes('pro')) currentUser.tier = 'pro';
      if (customer.tags.includes('factory')) currentUser.tier = 'factory';
    }
    
    currentUser.isLoggedIn = true;
    currentUser.id = customer.id || '';
    currentUser.provider = 'shopify';
    
    console.log('üîÑ Updated from Shopify customer object:', currentUser);
  }
  
  // If we have customer data but incomplete localStorage, update it
  if (window.customer && typeof window.customer === 'object' && window.customer.id && (!currentUser.email || currentUser.email === 'guest@piccatso.com' || currentUser.name === 'undefined undefined')) {
    console.log('üîß Updating incomplete customer data from window.customer');
    
    try {
      const customerId = window.customer.id || '';
      const customerEmail = window.customer.email || '';
      const firstName = window.customer.first_name || '';
      const lastName = window.customer.last_name || '';
      const customerName = (firstName + ' ' + lastName).trim() || 'Customer';
      
      currentUser.email = customerEmail;
      currentUser.name = customerName;
      currentUser.isLoggedIn = true;
      currentUser.id = customerId;
      currentUser.provider = 'shopify';
      
      // Update localStorage with complete data
      const completeUserData = {
        id: customerId,
        email: customerEmail,
        name: customerName,
        tier: currentUser.tier,
        isLoggedIn: true,
        provider: 'shopify',
        isFactory: currentUser.tier === 'factory'
      };
      localStorage.setItem('piccatso_user', JSON.stringify(completeUserData));
      console.log('üíæ Updated localStorage with complete data:', completeUserData);
    } catch (error) {
      console.error('‚ùå Error updating customer data:', error);
    }
  }
  
  // Set defaults if no data
  if (!currentUser.email) {
    currentUser.email = 'guest@piccatso.com';
    currentUser.name = 'Guest User';
    currentUser.isLoggedIn = false;
  }
  
  console.log('Loaded user data:', currentUser);
}

// Update user profile header
function updateUserProfile() {
  // Update avatar initials
  const initials = currentUser.name ? 
    currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'U';
  document.getElementById('avatar-initials').textContent = initials;
  
  // Update profile info
  document.getElementById('profile-name').textContent = currentUser.name || 'Welcome back!';
  document.getElementById('profile-email').textContent = currentUser.email || 'Loading...';
  
  // Update tier badge with proper styling
  const tierBadge = document.getElementById('tier-badge');
  const tierName = currentUser.tier ? currentUser.tier.charAt(0).toUpperCase() + currentUser.tier.slice(1) : 'Free';
  
  tierBadge.textContent = `${tierName} Tier`;
  
  // Color the profile header based on tier
  const profileHeader = document.getElementById('user-profile-header');
  switch(currentUser.tier) {
    case 'factory':
      profileHeader.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
      break;
    case 'pro':
      profileHeader.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      break;
    case 'premium':
      profileHeader.style.background = 'linear-gradient(135deg, #8B5CF6, #A855F7)';
      break;
    default:
      profileHeader.style.background = 'linear-gradient(135deg, #64748b, #475569)';
  }
  
  // Update login status
  const loginStatus = document.getElementById('login-status');
  if (currentUser.isLoggedIn) {
    loginStatus.textContent = '‚óè Online';
    loginStatus.style.color = '#10b981';
  } else {
    loginStatus.textContent = '‚óè Offline';
    loginStatus.style.color = '#ef4444';
  }
}

// Update dashboard statistics
function updateDashboardStats() {
  // Update subscription badge
  const badge = document.getElementById('subscription-badge');
  const usageProgress = document.getElementById('usage-progress');
  
  switch(currentUser.tier) {
    case 'premium':
      badge.textContent = '‚≠ê Premium Tier';
      badge.className = 'subscription-badge badge-premium';
      currentUser.generationsLimit = 100;
      break;
    case 'pro':
      badge.textContent = 'üé® Pro Tier';
      badge.className = 'subscription-badge badge-pro';
      currentUser.generationsLimit = 1000;
      break;
    default:
      badge.textContent = 'üÜì Free Tier';
      badge.className = 'subscription-badge badge-free';
      currentUser.generationsLimit = 10;
  }
  
  // Update usage stats
  document.getElementById('generations-used').textContent = currentUser.generationsUsed;
  document.getElementById('generations-limit').textContent = currentUser.generationsLimit;
  
  const usagePercent = (currentUser.generationsUsed / currentUser.generationsLimit) * 100;
  usageProgress.style.width = Math.min(usagePercent, 100) + '%';
  
  // Update quick stats
  document.getElementById('total-artworks').textContent = currentUser.artworks.length;
  document.getElementById('total-prints').textContent = currentUser.orders.length;
  document.getElementById('cart-items').textContent = currentUser.cartItems.length;
  document.getElementById('favorites-count').textContent = currentUser.artworks.filter(a => a.favorite).length;
}

// Load recent activity
function loadRecentActivity() {
  const activityContainer = document.getElementById('recent-activity');
  
  // Mock recent activity data
  const activities = [
    { type: 'creation', text: 'Created "Abstract Waves"', time: '2 hours ago' },
    { type: 'print', text: 'Ordered canvas print', time: '1 day ago' },
    { type: 'favorite', text: 'Added artwork to favorites', time: '3 days ago' }
  ];
  
  if (activities.length === 0) {
    activityContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üé®</div>
        <p>No recent activity yet.<br>Start creating some AI art!</p>
      </div>
    `;
  } else {
    activityContainer.innerHTML = activities.map(activity => `
      <div style="padding: 1rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between;">
        <span>${activity.text}</span>
        <span style="color: #64748b; font-size: 1.2rem;">${activity.time}</span>
      </div>
    `).join('');
  }
}

// Load artwork collection
function loadArtworkCollection() {
  const artworkGrid = document.getElementById('artwork-grid');
  
  if (currentUser.tier === 'free') {
    artworkGrid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üîí</div>
        <p>Artwork history is not available on the Free tier.<br>Upgrade to Premium to save your creations!</p>
        <button class="action-button" onclick="showSubscriptionModal()">
          Manage Subscription
        </button>
      </div>
    `;
    return;
  }
  
  if (currentUser.artworks.length === 0) {
    artworkGrid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üé®</div>
        <p>No artwork saved yet.<br>Create your first AI masterpiece!</p>
        <button class="action-button" onclick="window.location.href='/pages/create'">
          Create AI Art
        </button>
      </div>
    `;
  } else {
    artworkGrid.innerHTML = currentUser.artworks.map(artwork => `
      <div class="artwork-item" onclick="viewArtwork('${artwork.id}')">
        <img src="${artwork.image}" alt="${artwork.title}" class="artwork-image">
        <div class="artwork-overlay">
          <div>${artwork.title}</div>
          <div style="font-size: 1rem; opacity: 0.8;">${artwork.date}</div>
        </div>
      </div>
    `).join('');
  }
}

// Load cart items
function loadCartItems() {
  const cartContainer = document.getElementById('current-cart-items');
  const savedContainer = document.getElementById('saved-items');
  
  // Load current cart from Shopify
  fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
      if (cart.items.length === 0) {
        cartContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõí</div>
            <p>Your cart is empty.<br>Add some prints to get started!</p>
          </div>
        `;
      } else {
        cartContainer.innerHTML = cart.items.map(item => `
          <div class="cart-item">
            <img src="${item.image}" alt="${item.title}" class="cart-item-image">
            <div class="cart-item-details">
              <div class="cart-item-title">${item.title}</div>
              <div class="cart-item-price">$${(item.price / 100).toFixed(2)}</div>
            </div>
          </div>
        `).join('');
      }
    })
    .catch(error => {
      console.error('Error loading cart:', error);
    });
}

// Load order history
function loadOrderHistory() {
  const orderContainer = document.getElementById('order-history');
  
  if (currentUser.orders.length === 0) {
    orderContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì¶</div>
        <p>No orders yet.<br>Your print orders will appear here!</p>
      </div>
    `;
  } else {
    orderContainer.innerHTML = currentUser.orders.map(order => `
      <div style="padding: 1.5rem; border: 1px solid #e2e8f0; border-radius: 1rem; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
          <strong>Order #${order.id}</strong>
          <span style="color: #10b981;">$${order.total}</span>
        </div>
        <div style="color: #64748b;">
          <div>Date: ${order.date}</div>
          <div>Status: ${order.status}</div>
        </div>
      </div>
    `).join('');
  }
}

// Load account settings
function loadAccountSettings() {
  document.getElementById('user-email').value = currentUser.email;
  document.getElementById('user-name').value = currentUser.name;
  document.getElementById('current-plan').textContent = currentUser.tier.charAt(0).toUpperCase() + currentUser.tier.slice(1) + ' Tier';
}

// Upgrade modal functions
function showSubscriptionModal() {
  // Update current plan display
  updateCurrentPlanDisplay();
  
  // Show modal
  document.getElementById('subscription-modal').style.display = 'flex';
  
  // Hide action buttons initially
  document.getElementById('subscription-actions').style.display = 'none';
}

function closeSubscriptionModal() {
  document.getElementById('subscription-modal').style.display = 'none';
  selectedSubscriptionPlan = null;
  selectedSubscriptionAction = null;
  
  // Reset visual selections
  document.querySelectorAll('.subscription-plan').forEach(plan => {
    plan.style.borderColor = '#e2e8f0';
    plan.style.backgroundColor = 'transparent';
  });
}

function selectPlan(plan) {
  selectedPlan = plan;
  
  // Update visual selection
  document.querySelectorAll('#upgrade-modal > div > div:nth-child(2) > div').forEach(div => {
    div.style.borderColor = '#e2e8f0';
  });
  
  event.target.closest('div').style.borderColor = '#8B5CF6';
}

function processPlanUpgrade() {
  if (!selectedPlan) {
    showNotification('Please select a plan first.', 'error');
    return;
  }
  
  // Show loading state
  const upgradeBtn = document.querySelector('[onclick="processPlanUpgrade()"]');
  const originalText = upgradeBtn.textContent;
  upgradeBtn.textContent = 'Processing...';
  upgradeBtn.disabled = true;
  
  // Use subscription manager to upgrade
  if (window.subscriptionManager) {
    window.subscriptionManager.upgradeTier(selectedPlan).then(success => {
      if (success) {
        // Update local user data
        currentUser.tier = selectedPlan;
        
        // Update UI
        updateUserProfile();
        updateDashboardStats();
        
        // Update header navigation
        window.dispatchEvent(new Event('piccatso-auth-change'));
        
        // Reset button and close modal
        upgradeBtn.textContent = originalText;
        upgradeBtn.disabled = false;
        closeUpgradeModal();
        
        // Reset generations used for new tier
        currentUser.generationsUsed = 0;
        updateDashboardStats();
      } else {
        // Reset button on failure
        upgradeBtn.textContent = originalText;
        upgradeBtn.disabled = false;
      }
    });
  } else {
    // Fallback to local upgrade
    setTimeout(() => {
      // Update user tier
      currentUser.tier = selectedPlan;
      
      // Update localStorage
      const userData = JSON.parse(localStorage.getItem('piccatso_user') || '{}');
      userData.tier = selectedPlan;
      localStorage.setItem('piccatso_user', JSON.stringify(userData));
      localStorage.setItem('piccatso_user_data', JSON.stringify(currentUser));
      
      // Update UI
      updateUserProfile();
      updateDashboardStats();
      
      // Update header navigation
      window.dispatchEvent(new Event('piccatso-auth-change'));
      
      // Reset button and close modal
      upgradeBtn.textContent = originalText;
      upgradeBtn.disabled = false;
      closeUpgradeModal();
      
      // Show success notification
      const tierName = selectedPlan.charAt(0).toUpperCase() + selectedPlan.slice(1);
      showNotification(`Successfully upgraded to ${tierName} plan!`, 'success');
      
      // Reset generations used for new tier
      currentUser.generationsUsed = 0;
      updateDashboardStats();
    }, 2000);
  }
}

// Password management functions
function showPasswordForm() {
  document.getElementById('password-prompt').style.display = 'none';
  document.getElementById('password-form').style.display = 'block';
}

function cancelPasswordChange() {
  document.getElementById('password-form').style.display = 'none';
  document.getElementById('password-prompt').style.display = 'block';
  
  // Clear form fields
  document.getElementById('current-password').value = '';
  document.getElementById('new-password').value = '';
  document.getElementById('confirm-password').value = '';
}

async function updatePassword() {
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  
  // Validation
  if (!currentPassword || !newPassword || !confirmPassword) {
    alert('Please fill in all password fields.');
    return;
  }
  
  if (newPassword.length < 8) {
    alert('New password must be at least 8 characters long.');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('New passwords do not match.');
    return;
  }
  
  try {
    // Check if this is the Factory account
    const user = JSON.parse(localStorage.getItem('piccatso_user') || '{}');
    if (user.isFactory) {
      // Factory account password change
      if (currentPassword !== 'Msi08536') {
        alert('Current password is incorrect.');
        return;
      }
      
      // Update factory credentials (in real implementation, this would be server-side)
      alert('Factory account password updated successfully! Please remember your new password.');
      cancelPasswordChange();
      return;
    }
    
    // For regular Shopify customers, integrate with customer account API
    const response = await fetch('/account', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'form_type': 'customer_password',
        'utf8': '‚úì',
        'customer[password]': currentPassword,
        'customer[password_confirmation]': newPassword
      })
    });
    
    if (response.ok) {
      alert('Password updated successfully!');
      cancelPasswordChange();
    } else {
      const text = await response.text();
      if (text.includes('Current password is incorrect')) {
        alert('Current password is incorrect.');
      } else {
        alert('Failed to update password. Please try again.');
      }
    }
  } catch (error) {
    console.error('Password update error:', error);
    alert('Network error. Please try again.');
  }
}

function updateAccountSettings() {
  const newName = document.getElementById('user-name').value;
  
  if (!newName.trim()) {
    showNotification('Please enter a valid name.', 'error');
    return;
  }
  
  // Show loading state
  const updateBtn = document.querySelector('[onclick="updateAccountSettings()"]');
  const originalText = updateBtn.textContent;
  updateBtn.textContent = 'Updating...';
  updateBtn.disabled = true;
  
  setTimeout(() => {
    // Update current user data
    currentUser.name = newName.trim();
    
    // Update localStorage
    const userData = JSON.parse(localStorage.getItem('piccatso_user') || '{}');
    userData.name = newName.trim();
    localStorage.setItem('piccatso_user', JSON.stringify(userData));
    localStorage.setItem('piccatso_user_data', JSON.stringify(currentUser));
    
    // Update profile display
    updateUserProfile();
    
    // Update header navigation
    window.dispatchEvent(new Event('piccatso-auth-change'));
    
    // Reset button
    updateBtn.textContent = originalText;
    updateBtn.disabled = false;
    
    showNotification('Account settings updated successfully!', 'success');
  }, 1000);
}

// Notification system
function showNotification(message, type = 'info') {
  // Remove existing notifications
  const existingNotifications = document.querySelectorAll('.notification');
  existingNotifications.forEach(n => n.remove());
  
  // Create notification
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span class="notification-message">${message}</span>
      <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
    </div>
  `;
  
  // Add styles
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 0.8rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    animation: slideInRight 0.3s ease-out;
    max-width: 400px;
  `;
  
  notification.querySelector('.notification-content').style.cssText = `
    display: flex;
    align-items: center;
    gap: 1rem;
  `;
  
  notification.querySelector('.notification-close').style.cssText = `
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin-left: auto;
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

function manageBilling() {
  // This would integrate with Shopify's subscription billing
  alert('Redirecting to billing management... (This would integrate with Shopify billing portal)');
}

// Utility functions
function filterArtwork(filter) {
  // Implementation for artwork filtering
  console.log('Filtering artwork by:', filter);
  showNotification(`Filtering artwork by: ${filter}`, 'info');
}

function viewArtwork(artworkId) {
  // Implementation for viewing specific artwork
  console.log('Viewing artwork:', artworkId);
  showNotification('Opening artwork viewer...', 'info');
}

// Debug functions
function testCustomerData() {
  const debugOutput = document.getElementById('debug-output');
  const output = [];
  
  output.push('=== CUSTOMER DATA DEBUG ===');
  output.push('window.Shopify:', JSON.stringify(window.Shopify, null, 2));
  
  // Handle customer data safely
  try {
    if (window.customer && typeof window.customer === 'object') {
      output.push('window.customer: Available (object)');
      if (window.customer.id) output.push('‚úÖ Customer ID:', window.customer.id);
      if (window.customer.email) output.push('‚úÖ Customer email:', window.customer.email);
      if (window.customer.first_name) output.push('‚úÖ First name:', window.customer.first_name);
      if (window.customer.last_name) output.push('‚úÖ Last name:', window.customer.last_name);
      if (window.customer.tags) output.push('‚úÖ Customer tags:', window.customer.tags);
    } else {
      output.push('window.customer:', window.customer);
    }
  } catch (e) {
    output.push('window.customer: Error accessing -', e.message);
  }
  
  output.push('window.subscriptionManager:', window.subscriptionManager ? 'Available' : 'Not Available');
  
  try {
    if (window.subscriptionManager?.customer) {
      output.push('subscriptionManager.customer: Available');
      if (window.subscriptionManager.customer.id) output.push('‚úÖ SM Customer ID:', window.subscriptionManager.customer.id);
    } else {
      output.push('subscriptionManager.customer: Not available');
    }
  } catch (e) {
    output.push('subscriptionManager.customer: Error -', e.message);
  }
  
  output.push('currentUser:', JSON.stringify(currentUser, null, 2));
  output.push('localStorage piccatso_user:', localStorage.getItem('piccatso_user'));
  
  debugOutput.innerHTML = output.map(line => `<div style="margin-bottom: 0.5rem;">${line}</div>`).join('');
}

function setTestTier(tier) {
  if (window.subscriptionManager) {
    window.subscriptionManager.setCustomerTier(tier);
    setTimeout(() => {
      loadUserData();
      updateUserProfile();
      loadSubscriptionStatus();
    }, 500);
  } else {
    showNotification('Subscription manager not available', 'error');
  }
}

function refreshDashboard() {
  console.log('üîÑ Refreshing dashboard...');
  loadUserData();
  updateUserProfile();
  loadSubscriptionStatus();
  
  // Force update subscription manager if available
  if (window.subscriptionManager && window.customer) {
    window.subscriptionManager.customer = window.customer;
    window.subscriptionManager.loadCustomerData();
    window.subscriptionManager.updateUI();
  }
  
  showNotification('Dashboard refreshed', 'success');
}

// Inspect customer object function
function inspectCustomerObject() {
  const debugOutput = document.getElementById('debug-output');
  const output = [];
  
  output.push('=== CUSTOMER OBJECT INSPECTION ===');
  
  if (window.customer && typeof window.customer === 'object') {
    output.push('‚úÖ Customer object exists');
    
    // Try to access all possible properties (only necessary ones)
    const properties = ['id', 'email', 'first_name', 'last_name', 'tags'];
    
    properties.forEach(prop => {
      try {
        const value = window.customer[prop];
        if (value !== undefined && value !== null) {
          output.push(`‚úÖ ${prop}: ${value}`);
        } else {
          output.push(`‚ùå ${prop}: undefined/null`);
        }
      } catch (e) {
        output.push(`‚ùå ${prop}: Error - ${e.message}`);
      }
    });
    
    // Try to get all enumerable properties
    try {
      const allProps = Object.keys(window.customer);
      output.push('üìã All properties:', allProps.join(', '));
      
      // Show the actual values for each property
      allProps.forEach(prop => {
        try {
          const value = window.customer[prop];
          output.push(`üîç ${prop}: ${typeof value} = ${value}`);
        } catch (e) {
          output.push(`üîç ${prop}: Error accessing - ${e.message}`);
        }
      });
    } catch (e) {
      output.push('‚ùå Cannot enumerate properties:', e.message);
    }
    
    // Try to stringify the entire object (this might fail but let's try)
    try {
      const customerString = JSON.stringify(window.customer, null, 2);
      output.push('üìÑ Full customer object:');
      output.push(customerString);
    } catch (e) {
      output.push('‚ùå Cannot stringify customer object:', e.message);
    }
    
  } else {
    output.push('‚ùå No customer object found');
  }
  
  debugOutput.innerHTML = output.map(line => `<div style="margin-bottom: 0.5rem; font-size: 1.1rem;">${line}</div>`).join('');
}

// Manual customer fix function
function manualCustomerFix() {
  console.log('üîß Manual customer fix...');
  
  // Since we know the customer object exists but properties might be different,
  // let's try to extract data using multiple methods
  
  let customerId = 'unknown';
  let customerEmail = 'guest@piccatso.com';
  let customerName = 'Customer User';
  
  if (window.customer && typeof window.customer === 'object') {
    // Try different property names (only necessary ones)
    const possibleIdProps = ['id'];
    const possibleEmailProps = ['email'];
    const possibleNameProps = ['first_name', 'last_name'];
    
    // Try to find ID
    for (const prop of possibleIdProps) {
      if (window.customer[prop]) {
        customerId = window.customer[prop];
        break;
      }
    }
    
    // Try to find email
    for (const prop of possibleEmailProps) {
      if (window.customer[prop]) {
        customerEmail = window.customer[prop];
        break;
      }
    }
    
    // Construct name from first and last name
    const firstName = window.customer.first_name || 'Customer';
    const lastName = window.customer.last_name || 'User';
    customerName = `${firstName} ${lastName}`.trim();
  }
  
  // Create the fixed user data
  const fixedUserData = {
    id: customerId,
    email: customerEmail,
    name: customerName,
    tier: 'free', // Default tier for new accounts
    isLoggedIn: true,
    provider: 'shopify',
    generationsUsed: 0,
    generationsLimit: 10,
    artworks: [],
    cartItems: [],
    orders: []
  };
  
  console.log('üîß Fixed user data:', fixedUserData);
  
  // Update localStorage
  localStorage.setItem('piccatso_user', JSON.stringify(fixedUserData));
  
  // Update current user
  currentUser = fixedUserData;
  
  // Update UI
  updateUserProfile();
  loadSubscriptionStatus();
  
  // Update subscription manager
  if (window.subscriptionManager) {
    window.subscriptionManager.customer = window.customer;
    window.subscriptionManager.currentTier = 'pro';
    window.subscriptionManager.updateUI();
  }
  
  showNotification('Customer data manually fixed!', 'success');
  
  // Reload page to ensure all components get the updated data
  setTimeout(() => {
    window.location.reload();
  }, 1000);
}

// Force load customer data function
function forceLoadCustomerData() {
  console.log('üîß Force loading customer data...');
  
  try {
    // Check if we can access customer data
    if (window.customer && typeof window.customer === 'object') {
      console.log('üîç Customer object found:', window.customer);
      
      // Try to access customer properties safely
      const customerId = window.customer.id || 'unknown';
      const customerEmail = window.customer.email || 'unknown@example.com';
      const firstName = window.customer.first_name || '';
      const lastName = window.customer.last_name || '';
      const customerName = (firstName + ' ' + lastName).trim() || 'Customer';
      
      console.log('üìã Customer details:', { customerId, customerEmail, customerName });
      
      // Create complete user data
      const completeUserData = {
        id: customerId,
        email: customerEmail,
        name: customerName,
        tier: 'pro', // You had pro tier in localStorage
        isLoggedIn: true,
        provider: 'shopify',
        isFactory: false
      };
      
      // Update localStorage
      localStorage.setItem('piccatso_user', JSON.stringify(completeUserData));
      
      // Update current user
      currentUser = { ...currentUser, ...completeUserData };
      
      // Update UI
      updateUserProfile();
      loadSubscriptionStatus();
      
      // Update subscription manager
      if (window.subscriptionManager) {
        window.subscriptionManager.customer = window.customer;
        window.subscriptionManager.currentTier = 'pro';
        window.subscriptionManager.updateUI();
      }
      
      showNotification('Customer data force loaded!', 'success');
      console.log('‚úÖ Customer data force loaded:', completeUserData);
      
      // Refresh the page to show changes
      setTimeout(() => {
        window.location.reload();
      }, 1000);
      
    } else {
      console.log('‚ùå No valid customer object found');
      showNotification('No customer data available to load', 'error');
    }
  } catch (error) {
    console.error('‚ùå Error force loading customer data:', error);
    showNotification('Error loading customer data: ' + error.message, 'error');
  }
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeDashboard();
  
  // Wait for subscription manager to load and refresh data
  setTimeout(() => {
    if (window.subscriptionManager) {
      // Force customer data into subscription manager
      if (window.customer && !window.subscriptionManager.customer) {
        window.subscriptionManager.customer = window.customer;
        console.log('üîß Manually set customer data in subscription manager');
      }
      loadUserData();
      updateUserProfile();
      loadSubscriptionStatus();
    }
  }, 1000);
  
  // Also try after a longer delay
  setTimeout(() => {
    if (window.customer && window.subscriptionManager) {
      window.subscriptionManager.customer = window.customer;
      loadUserData();
      updateUserProfile();
      loadSubscriptionStatus();
      console.log('üîß Second attempt to load customer data');
    }
  }, 2000);
  
  // Check URL hash for direct tab navigation
  const hash = window.location.hash.substring(1);
  if (hash && ['overview', 'artwork', 'cart', 'orders', 'settings'].includes(hash)) {
    // Update active tab
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`[onclick="showDashboardTab('${hash}')"]`)?.classList.add('active');
    
    // Show content
    document.querySelectorAll('.dashboard-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(hash + '-content')?.classList.add('active');
    
    // Load tab-specific data
    switch(hash) {
      case 'artwork':
        loadArtworkCollection();
        break;
      case 'cart':
        loadCartItems();
        break;
      case 'orders':
        loadOrderHistory();
        break;
      case 'settings':
        loadAccountSettings();
        break;
    }
  }
});

// Handle hash changes for direct linking
window.addEventListener('hashchange', function() {
  const hash = window.location.hash.substring(1);
  if (hash && ['overview', 'artwork', 'cart', 'orders', 'settings'].includes(hash)) {
    showDashboardTab(hash);
  }
});

// Export functions for global access
window.showDashboardTab = showDashboardTab;
window.showUpgradeModal = showUpgradeModal;
window.closeUpgradeModal = closeUpgradeModal;
window.selectPlan = selectPlan;
window.processPlanUpgrade = processPlanUpgrade;
window.updateAccountSettings = updateAccountSettings;
window.showPasswordForm = showPasswordForm;
window.cancelPasswordChange = cancelPasswordChange;
window.updatePassword = updatePassword;

// Subscription management functions
window.showUpgradeOptions = function() {
  if (window.subscriptionManager) {
    window.subscriptionManager.showUpgradeModal('Choose a plan that fits your needs!');
  }
};

window.upgradeToPremium = function() {
  if (window.subscriptionManager) {
    window.subscriptionManager.upgradeTier('premium');
  }
};

window.upgradeToPro = function() {
  if (window.subscriptionManager) {
    window.subscriptionManager.upgradeTier('pro');
  }
};

// Subscription Management Functions
let selectedSubscriptionPlan = null;
let selectedSubscriptionAction = null;

function selectSubscriptionPlan(plan, action) {
  selectedSubscriptionPlan = plan;
  selectedSubscriptionAction = action;
  
  // Reset visual selections
  document.querySelectorAll('.subscription-plan').forEach(p => {
    p.style.borderColor = '#e2e8f0';
    p.style.backgroundColor = 'transparent';
  });
  
  // Highlight selected plan
  const selectedElement = document.querySelector(`[data-plan="${plan}"]`);
  selectedElement.style.borderColor = action === 'upgrade' ? '#10b981' : '#f59e0b';
  selectedElement.style.backgroundColor = action === 'upgrade' ? '#f0fdf4' : '#fffbeb';
  
  // Show action buttons and update content
  showSubscriptionAction(plan, action);
}

function showSubscriptionAction(plan, action) {
  const actionsDiv = document.getElementById('subscription-actions');
  const descriptionDiv = document.getElementById('action-description');
  const confirmBtn = document.getElementById('confirm-subscription-action');
  
  actionsDiv.style.display = 'block';
  
  if (action === 'upgrade') {
    descriptionDiv.innerHTML = `
      <strong>Upgrade to ${plan.charAt(0).toUpperCase() + plan.slice(1)} Tier</strong><br>
      You will be redirected to checkout to complete your subscription upgrade. 
      Your new plan will be active immediately after payment.
    `;
    confirmBtn.textContent = 'Upgrade Now';
    confirmBtn.style.background = '#10b981';
    confirmBtn.onclick = () => processSubscriptionUpgrade(plan);
  } else if (action === 'downgrade') {
    descriptionDiv.innerHTML = `
      <strong>Downgrade to Free Tier</strong><br>
      Your current subscription will remain active until the next billing date. 
      After that, you'll be moved to the Free tier with limited features.
    `;
    confirmBtn.textContent = 'Schedule Downgrade';
    confirmBtn.style.background = '#f59e0b';
    confirmBtn.onclick = () => processSubscriptionDowngrade(plan);
  }
}

function updateCurrentPlanDisplay() {
  const currentPlanDiv = document.getElementById('current-plan-display');
  const currentTier = currentUser.tier || 'free';
  
  const planInfo = {
    free: { name: 'Free Tier', price: '$0/month', features: ['10 generations/month', 'Standard resolution', 'Watermarked downloads'] },
    premium: { name: 'Premium Tier', price: '$9.99/month', features: ['100 generations/month', 'High resolution', 'Art history saved'] },
    pro: { name: 'Pro Tier', price: '$39.99/month', features: ['200 generations/month', 'Ultra HD', 'Commercial rights', 'Print discount'] }
  };
  
  const plan = planInfo[currentTier];
  
  currentPlanDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h4 style="margin: 0; color: #1e293b;">${plan.name}</h4>
      <span style="font-size: 1.2rem; font-weight: bold; color: #1e293b;">${plan.price}</span>
    </div>
    <ul style="margin: 0; padding-left: 1.5rem; color: #64748b; font-size: 0.9rem;">
      ${plan.features.map(feature => `<li>${feature}</li>`).join('')}
    </ul>
  `;
}

function processSubscriptionUpgrade(plan) {
  // Show loading state
  const confirmBtn = document.getElementById('confirm-subscription-action');
  const originalText = confirmBtn.textContent;
  confirmBtn.textContent = 'Processing...';
  confirmBtn.disabled = true;
  
  // Get subscription URLs from configuration
  const subscriptionUrls = window.PiccatsoSubscriptionConfig?.subscriptionUrls || {
    premium: '/products/premium-subscription', // Default fallback
    pro: '/products/pro-subscription' // Default fallback
  };
  
  const productUrl = subscriptionUrls[plan];
  if (!productUrl) {
    showNotification('Subscription product not found. Please contact support.', 'error');
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
    return;
  }
  
  // Show notification and redirect
  showNotification(`Redirecting to ${plan.charAt(0).toUpperCase() + plan.slice(1)} subscription page...`, 'success');
  
  // Redirect to the subscription product page (which will have the subscription widget)
  setTimeout(() => {
    window.location.href = productUrl;
  }, 1000);
}

function processSubscriptionDowngrade(plan) {
  // Show loading state
  const confirmBtn = document.getElementById('confirm-subscription-action');
  const originalText = confirmBtn.textContent;
  confirmBtn.textContent = 'Processing...';
  confirmBtn.disabled = true;
  
  // For downgrades, we'll update the customer metafields to schedule the change
  // This would typically be done via a webhook or admin action
  fetch('/apps/subscription-manager/downgrade', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      customerId: currentUser.id,
      newTier: plan,
      action: 'schedule_downgrade'
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Downgrade scheduled successfully. Your current plan remains active until the next billing date.', 'success');
      closeSubscriptionModal();
    } else {
      throw new Error(data.message || 'Failed to schedule downgrade');
    }
  })
  .catch(error => {
    console.error('Error scheduling downgrade:', error);
    showNotification('Failed to schedule downgrade. Please contact support.', 'error');
    
    // Reset button
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
  });
}

function manageBilling() {
  // Get subscription management URL from configuration
  const subscriptionManagementUrl = window.PiccatsoSubscriptionConfig?.subscriptionManagementUrl || '/account';
  
  // Show notification and redirect
  showNotification('Redirecting to subscription management...', 'success');
  setTimeout(() => {
    window.location.href = subscriptionManagementUrl;
  }, 500);
}
</script>
